{"version":3,"file":"pg.js","sources":["../../src/instrumentation/pg.ts"],"sourcesContent":["import { Notifier } from '../notifier';\n\nconst SPAN_NAME = 'sql';\n\nexport function patch(pg, airbrake: Notifier): void {\n  patchClient(pg.Client, airbrake);\n\n  const origGetter = pg.__lookupGetter__('native');\n  if (origGetter) {\n    delete pg.native;\n    pg.__defineGetter__('native', function() {\n      const native = origGetter();\n      if (native && native.Client) {\n        patchClient(native.Client, airbrake);\n      }\n      return native;\n    });\n  }\n}\n\nfunction patchClient(Client, airbrake: Notifier): void {\n  const origQuery = Client.prototype.query;\n  Client.prototype.query = function abQuery() {\n    const metric = airbrake.scope().routeMetric();\n    metric.startSpan(SPAN_NAME);\n    if (!metric.isRecording()) {\n      return origQuery.apply(this, arguments);\n    }\n\n    let cbIdx = arguments.length - 1;\n    let cb = arguments[cbIdx];\n    if (Array.isArray(cb)) {\n      cbIdx = cb.length - 1;\n      cb = cb[cbIdx];\n    }\n\n    if (typeof cb === 'function') {\n      arguments[cbIdx] = function abCallback() {\n        metric.endSpan(SPAN_NAME);\n        return cb.apply(this, arguments);\n      };\n      return origQuery.apply(this, arguments);\n    }\n\n    const query = origQuery.apply(this, arguments);\n\n    const endSpan = () => {\n      metric.endSpan(SPAN_NAME);\n    };\n\n    if (typeof query.on === 'function') {\n      query.on('end', endSpan);\n      query.on('error', endSpan);\n    } else if (typeof query.then === 'function') {\n      query.then(endSpan);\n    }\n\n    return query;\n  };\n}\n"],"names":[],"mappings":";;;;AAEA,IAAM,SAAS,GAAG,KAAK,CAAC;AAExB,SAAgB,KAAK,CAAC,EAAE,EAAE,QAAkB;IAC1C,WAAW,CAAC,EAAE,CAAC,MAAM,EAAE,QAAQ,CAAC,CAAC;IAEjC,IAAM,UAAU,GAAG,EAAE,CAAC,gBAAgB,CAAC,QAAQ,CAAC,CAAC;IACjD,IAAI,UAAU,EAAE;QACd,OAAO,EAAE,CAAC,MAAM,CAAC;QACjB,EAAE,CAAC,gBAAgB,CAAC,QAAQ,EAAE;YAC5B,IAAM,MAAM,GAAG,UAAU,EAAE,CAAC;YAC5B,IAAI,MAAM,IAAI,MAAM,CAAC,MAAM,EAAE;gBAC3B,WAAW,CAAC,MAAM,CAAC,MAAM,EAAE,QAAQ,CAAC,CAAC;aACtC;YACD,OAAO,MAAM,CAAC;SACf,CAAC,CAAC;KACJ;CACF;AAED,SAAS,WAAW,CAAC,MAAM,EAAE,QAAkB;IAC7C,IAAM,SAAS,GAAG,MAAM,CAAC,SAAS,CAAC,KAAK,CAAC;IACzC,MAAM,CAAC,SAAS,CAAC,KAAK,GAAG,SAAS,OAAO;QACvC,IAAM,MAAM,GAAG,QAAQ,CAAC,KAAK,EAAE,CAAC,WAAW,EAAE,CAAC;QAC9C,MAAM,CAAC,SAAS,CAAC,SAAS,CAAC,CAAC;QAC5B,IAAI,CAAC,MAAM,CAAC,WAAW,EAAE,EAAE;YACzB,OAAO,SAAS,CAAC,KAAK,CAAC,IAAI,EAAE,SAAS,CAAC,CAAC;SACzC;QAED,IAAI,KAAK,GAAG,SAAS,CAAC,MAAM,GAAG,CAAC,CAAC;QACjC,IAAI,EAAE,GAAG,SAAS,CAAC,KAAK,CAAC,CAAC;QAC1B,IAAI,KAAK,CAAC,OAAO,CAAC,EAAE,CAAC,EAAE;YACrB,KAAK,GAAG,EAAE,CAAC,MAAM,GAAG,CAAC,CAAC;YACtB,EAAE,GAAG,EAAE,CAAC,KAAK,CAAC,CAAC;SAChB;QAED,IAAI,OAAO,EAAE,KAAK,UAAU,EAAE;YAC5B,SAAS,CAAC,KAAK,CAAC,GAAG,SAAS,UAAU;gBACpC,MAAM,CAAC,OAAO,CAAC,SAAS,CAAC,CAAC;gBAC1B,OAAO,EAAE,CAAC,KAAK,CAAC,IAAI,EAAE,SAAS,CAAC,CAAC;aAClC,CAAC;YACF,OAAO,SAAS,CAAC,KAAK,CAAC,IAAI,EAAE,SAAS,CAAC,CAAC;SACzC;QAED,IAAM,KAAK,GAAG,SAAS,CAAC,KAAK,CAAC,IAAI,EAAE,SAAS,CAAC,CAAC;QAE/C,IAAM,OAAO,GAAG;YACd,MAAM,CAAC,OAAO,CAAC,SAAS,CAAC,CAAC;SAC3B,CAAC;QAEF,IAAI,OAAO,KAAK,CAAC,EAAE,KAAK,UAAU,EAAE;YAClC,KAAK,CAAC,EAAE,CAAC,KAAK,EAAE,OAAO,CAAC,CAAC;YACzB,KAAK,CAAC,EAAE,CAAC,OAAO,EAAE,OAAO,CAAC,CAAC;SAC5B;aAAM,IAAI,OAAO,KAAK,CAAC,IAAI,KAAK,UAAU,EAAE;YAC3C,KAAK,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;SACrB;QAED,OAAO,KAAK,CAAC;KACd,CAAC;CACH;;;;"}